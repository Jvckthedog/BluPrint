<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Albums — Jordan McCollum</title>
    <link rel="stylesheet" href="./assets/css/style.css?v=6" />
  </head>

  <body>
    <main class="main">
      <div class="container">
        <header class="site-header">
          <div class="site-header__title">
            <h1>ALBUMS</h1>
          </div>
          <nav class="site-header__nav">
            <a href="./index.html" class="site-header__link">HOME</a>
            <a href="#" class="site-header__link" id="aboutLink">ABOUT</a>
          </nav>
        </header>

        <section class="albums-section">
          <div id="albumsMsg" class="muted">Loading albums…</div>
          <div id="albums" class="albums"></div>
        </section>
      </div>
    </main>

    <!-- Upload modal -->
    <div class="modal" id="uploadModal" aria-hidden="true">
      <div class="modal__backdrop" data-close="true"></div>

      <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="uploadTitle">
        <div class="modal__header">
          <h2 id="uploadTitle" class="modal__title">Upload photos</h2>
          <button class="icon-btn" id="closeModalBtn" aria-label="Close">✕</button>
        </div>

        <div class="modal__body">
          <label class="field">
            <span class="field__label">Choose album</span>
            <select id="albumSelect" class="select"></select>
          </label>

          <label class="field">
            <span class="field__label">Choose photos</span>
            <input id="file" type="file" accept="image/*" multiple />
          </label>

          <p id="msg" class="muted"></p>
        </div>

        <div class="modal__footer">
          <button id="startUploadBtn" class="upload-btn">Upload</button>
        </div>
      </div>
    </div>

    <footer class="footer" id="footer">
      <div class="footer__actions">
        <button id="addAlbumBtn" class="upload-btn">Add album</button>
        <button id="uploadBtn" class="upload-btn">Upload photos</button>
      </div>
      <p class="footer__copyright">© 2026 Jordan McCollum</p>
    </footer>

    <script>
      const API = "https://jrdnmccllm-api.mccollum-jrdn.workers.dev";

      const PASSWORD_KEY = "jrdn_upload_password";
      const MANUAL_ALBUMS_KEY = "jrdn_manual_albums";

      const albumsEl = document.getElementById("albums");
      const albumsMsg = document.getElementById("albumsMsg");

      const uploadModal = document.getElementById("uploadModal");
      const albumSelect = document.getElementById("albumSelect");
      const fileInput = document.getElementById("file");
      const msg = document.getElementById("msg");

      function getUploadPassword() {
        let pw = localStorage.getItem(PASSWORD_KEY);
        if (!pw) {
          pw = prompt("Enter upload password:");
          if (pw) localStorage.setItem(PASSWORD_KEY, pw);
        }
        return pw || "";
      }

      function clearSavedPassword() {
        localStorage.removeItem(PASSWORD_KEY);
      }

      function slugifyAlbum(name) {
        return name
          .trim()
          .toLowerCase()
          .replace(/[^a-z0-9\s-_]/g, "")
          .replace(/\s+/g, "-")
          .replace(/-+/g, "-");
      }

      function loadManualAlbums() {
        try {
          return JSON.parse(localStorage.getItem(MANUAL_ALBUMS_KEY) || "[]");
        } catch {
          return [];
        }
      }

      function saveManualAlbums(albums) {
        localStorage.setItem(MANUAL_ALBUMS_KEY, JSON.stringify(albums));
      }

      function openModal() {
        uploadModal.classList.add("modal--open");
        uploadModal.setAttribute("aria-hidden", "false");
      }

      function closeModal() {
        uploadModal.classList.remove("modal--open");
        uploadModal.setAttribute("aria-hidden", "true");
        msg.textContent = "";
        fileInput.value = "";
      }

      function setAlbumOptions(albums) {
        albumSelect.innerHTML = "";
        for (const a of albums) {
          const opt = document.createElement("option");
          opt.value = a;
          opt.textContent = a;
          albumSelect.appendChild(opt);
        }
      }

      // Groups keys like: albums/<album>/<file>
      function groupKeysIntoAlbums(keys) {
        const map = new Map();
        for (const key of keys) {
          if (!key.startsWith("albums/")) continue;
          const parts = key.split("/");
          const album = parts[1];
          if (!album) continue;
          if (!map.has(album)) map.set(album, []);
          map.get(album).push(key);
        }
        for (const [album, arr] of map) {
          map.set(album, arr.slice().sort().reverse());
        }
        return map;
      }

      function renderAlbums(albumMap) {
        albumsEl.innerHTML = "";

        const albums = Array.from(albumMap.keys()).sort((a, b) => a.localeCompare(b));
        if (albums.length === 0) {
          albumsMsg.textContent = "No albums yet. Add one, then upload photos into it.";
          return;
        }
        albumsMsg.textContent = "";

        for (const album of albums) {
          const keys = albumMap.get(album) || [];

          const item = document.createElement("div");
          item.className = "album";

          const header = document.createElement("button");
          header.className = "album__header";
          header.type = "button";
          header.setAttribute("aria-expanded", "false");

          const left = document.createElement("div");
          left.className = "album__title";
          left.textContent = album;

          const count = document.createElement("div");
          count.className = "album__count";
          count.textContent = `${keys.length} photos`;

          const chevron = document.createElement("div");
          chevron.className = "album__chevron";
          chevron.textContent = ">";

          header.appendChild(left);
          header.appendChild(count);
          header.appendChild(chevron);

          const panel = document.createElement("div");
          panel.className = "album__panel";

          const grid = document.createElement("div");
          grid.className = "gallery gallery--album";
          panel.appendChild(grid);

          let hydrated = false;

          header.addEventListener("click", () => {
            const isOpen = item.classList.toggle("album--open");
            header.setAttribute("aria-expanded", String(isOpen));

            // Like ChatGPT’s GPTs sidebar: don’t render photos until opened
            if (isOpen && !hydrated) {
              hydrated = true;
              for (const key of keys) {
                const wrap = document.createElement("div");
                wrap.className = "thumb";

                const img = document.createElement("img");
                img.src = `${API}/file/${encodeURIComponent(key)}`;
                img.alt = key;
                img.loading = "lazy";

                wrap.appendChild(img);
                grid.appendChild(wrap);
              }
            }
          });

          item.appendChild(header);
          item.appendChild(panel);
          albumsEl.appendChild(item);
        }
      }

      async function refresh() {
        albumsMsg.textContent = "Loading albums…";
        albumsEl.innerHTML = "";

        const res = await fetch(`${API}/list`);
        if (!res.ok) {
          albumsMsg.textContent = "Could not load albums.";
          return;
        }

        const data = await res.json();
        const keys = data.keys || [];

        const albumMap = groupKeysIntoAlbums(keys);

        // allow “empty albums” via localStorage
        const manual = loadManualAlbums();
        for (const a of manual) {
          if (!albumMap.has(a)) albumMap.set(a, []);
        }

        renderAlbums(albumMap);
        setAlbumOptions(Array.from(albumMap.keys()).sort((a, b) => a.localeCompare(b)));
      }

      // Footer buttons
      document.getElementById("addAlbumBtn").addEventListener("click", async () => {
        const name = prompt("Album name?");
        if (!name) return;
        const slug = slugifyAlbum(name);
        if (!slug) return;

        const existing = new Set(loadManualAlbums());
        existing.add(slug);
        saveManualAlbums(Array.from(existing).sort());
        await refresh();
      });

      document.getElementById("uploadBtn").addEventListener("click", () => {
        const pw = getUploadPassword();
        if (!pw) return;
        openModal();
      });

      // Modal close behavior
      document.getElementById("closeModalBtn").addEventListener("click", closeModal);
      uploadModal.addEventListener("click", (e) => {
        if (e.target?.dataset?.close === "true") closeModal();
      });
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });

      // Upload into albums/<album>/...
      document.getElementById("startUploadBtn").addEventListener("click", async () => {
        const files = Array.from(fileInput.files);
        if (!files.length) {
          msg.textContent = "Choose at least one photo.";
          return;
        }

        const album = albumSelect.value;
        if (!album) {
          msg.textContent = "Choose an album.";
          return;
        }

        const pw = getUploadPassword();
        if (!pw) {
          msg.textContent = "Upload password required.";
          return;
        }

        msg.textContent = `Uploading 1 of ${files.length}…`;

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const safeName = `${Date.now()}-${file.name}`.replaceAll(" ", "_");
          const key = `albums/${album}/${safeName}`;

          msg.textContent = `Uploading ${i + 1} of ${files.length}…`;

          const res = await fetch(`${API}/${encodeURIComponent(key)}`, {
            method: "PUT",
            body: file,
            headers: {
              "Content-Type": file.type || "application/octet-stream",
              "X-Upload-Password": pw,
            },
          });

          if (res.status === 401) {
            clearSavedPassword();
            msg.textContent = "Wrong password — try again.";
            return;
          }

          if (!res.ok) {
            msg.textContent = `Upload failed on ${file.name}.`;
            return;
          }
        }

        msg.textContent = "Upload complete ✅";
        fileInput.value = "";
        await refresh();
        setTimeout(closeModal, 400);
      });

      // About placeholder
      document.getElementById("aboutLink").addEventListener("click", (e) => {
        e.preventDefault();
        alert("About page coming soon.");
      });

      refresh();
    </script>
  </body>
</html>